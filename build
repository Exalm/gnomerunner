#!/bin/bash

rm temp -rf
mkdir temp
cp install.rdf temp
cp theme temp -r
cp options temp -r
cp icon.png temp/theme
cp icon.png temp/options
cd temp


cd theme/icons

#Generate layers

echo "Generating icon layers..."

SIZES="16 22 24 48"

for F in layer-*; do
    echo " $F"
    echo "/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

@import url(\"chrome://icons/skin/icon-theme-base.css\");

:root {" > $F.css

    while read -r LINE; do
        LINE1=`echo $LINE | grep -Po "^[\w-]+"`
        LINE2=`echo $LINE | grep -Po "[\w-]+$"`
        for S in $SIZES; do
            echo "  --icon-$LINE1-$S: url(\"moz-icon://stock/$LINE2?size=$S\");" >> $F.css
            echo "  --icon-$LINE1-$S-dis: url(\"moz-icon://stock/$LINE2?size=$S&state=disabled\");" >> $F.css
        done
        echo "  --icon-$LINE1-dis-opacity: var(--icon-base-dis-native-opacity);"  >> $F.css
        echo ""  >> $F.css
    done < $F

    echo "}" >> $F.css
    rm $F

    sed -E "s/(size=)16/\1menu/g;s/(size=)22/\1button/g;s/(size=)24/\1toolbar/g;s/(size=)48/\1dialog/g;" -i $F.css
done

#Generate icon theme css

echo "Generating icon themes..."
SIZES="16 20 22 24 32 48"

for THEME in `echo */ | sed -E "s/\///g"`; do
    echo " $THEME"
    cd $THEME

    BASE=`cat base`
    rm base

    FILES=""
    DIRS=`ls -v`
    for D in $SIZES; do
        if [ -d ${D}x$D ]; then
            cd ${D}x$D
            TMP_F=`find * -type f -name "*.png"`
            FILES="$FILES $TMP_F"
            cd ..
        fi
    done
    FILES=`echo $FILES | sed -E "s/\.png//g;s/\s+/\\n/g" | sort | uniq`
    cd ..

    touch icon-theme-$THEME.css
    echo "/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

@import url(\"chrome://icons/skin/icon-theme-$BASE.css\");

:root {" > icon-theme-$THEME.css
    for F in $FILES; do
        D=`echo $F | grep -Po "^[\w\d-_\.]+"`
        N=`echo $F | grep -Po "[\w\d-_]+$"`
        for DD in $SIZES; do
            if [ -f $THEME/${DD}x$DD/$D/$N.png ]; then
                echo "  --icon-$N-$DD: url(\"chrome://icons/skin/$THEME/${DD}x$DD/$D/$N.png\");" >> icon-theme-$THEME.css
                echo "  --icon-$N-$DD-dis: var(--icon-$N-$DD);" >> icon-theme-$THEME.css
            fi
        done
        echo "  --icon-$N-dis-opacity: var(--icon-base-dis-opacity);" >> icon-theme-$THEME.css
        echo "" >> icon-theme-$THEME.css
    done
    echo '}' >> icon-theme-$THEME.css
done

cd ../..

#Create Freedesktop theme
echo "Creating -fd theme (deprecated)..."
mkdir fd
cp -R theme fd/theme
cp install.rdf fd
sed -E "s/((INTERNAL_)?NAME|THEME_(ID|DESC))/\0_FD/g" -i "fd/theme/install.rdf" "fd/theme/chrome.manifest" "fd/install.rdf"

#Substitute variables
echo "Substituting variables..."
FILES=`find . -type f -exec grep -Iq . {} \; -and -print`
while read LINE; do
    if [[ $LINE != [A-Z]* ]]; then
        continue
    fi
    LINE1=`echo $LINE | grep -oE "^[^=]+"`
    LINE2=`echo $LINE | grep -oE "[^=]+$"`
    sed "s|\$$LINE1|$LINE2|g" -i $FILES
    eval "$LINE1=\"$LINE2\""
done < "../config.txt"

#Output icons
cd theme
FILES=`find . -name "*.css"`
for F in $FILES; do
  N=`grep CUSTOM-ICON $F -c`
  if (( N > 0 )); then
    echo $F
    echo " $N"
  fi
done

echo "Substituting icons (deprecated)..."
#Substitute icons
for F in $FILES; do
    ORIG="%CUSTOM-ICON ([^ ]+) ([0-9]+b?)( (disabled))?"
    NEW1="chrome:\/\/global\/skin\/icons\/\2x\2\/\1.png"
    NEW2="moz-icon:\/\/stock\/\1?size=\2\&state=\4"
    sed -E "s/$ORIG/$NEW1/g" -i "$F"
    sed -E "s/$ORIG/$NEW2/g" -i "../fd/theme/$F"

    sed -E "s/16bx16b/16x16/g" -i "$F" "../fd/theme/$F"
    sed -E "s/size=16b/size=button/g" -i "$F" "../fd/theme/$F"
    sed -E "s/size=16/size=menu/g" -i "$F" "../fd/theme/$F"
    sed -E "s/size=22/size=button/g" -i "$F" "../fd/theme/$F"
    sed -E "s/size=24/size=toolbar/g" -i "$F" "../fd/theme/$F"
    sed -E "s/size=48/size=dialog/g" -i "$F" "../fd/theme/$F"
    sed -E "s/&state=\"/\"/g" -i "$F" "../fd/theme/$F"

    sed -E "s/%DISABLED-OPACITY/0.5/g" -i "$F"
    sed -E "s/%DISABLED-OPACITY/1.0/g" -i "../fd/theme/$F"
done
cd ..

cp -R options fd

echo "Packaging..."
#Package
THEME_JAR="theme.jar"
OPTIONS_JAR="options.xpi"
NAME="gnomerunnergtk-revived-$VERSION-sm-linux.xpi"
NAME_FD="gnomerunnerfd-revived-$VERSION-sm-linux.xpi"
cd theme
zip ../$THEME_JAR * -qr
cd ../options
zip ../$OPTIONS_JAR * -qr
cd ..
zip ../$NAME $THEME_JAR $OPTIONS_JAR install.rdf -q
cd fd/theme
zip ../$THEME_JAR * -qr
cd ../options
zip ../$OPTIONS_JAR * -qr
cd ..
zip ../../$NAME_FD $THEME_JAR $OPTIONS_JAR install.rdf -q
cd ../..

